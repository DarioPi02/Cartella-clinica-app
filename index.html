<!DOCTYPE html>
<html lang="it" class="h-full bg-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cartella Clinica</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <script>
        // La tua configurazione Firebase qui
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        firebase.initializeApp(firebaseConfig);
    </script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .form-section-title { font-size: 1.5rem; font-weight: 700; color: #2563eb; margin-bottom: 0.5rem; padding-bottom: 0.5rem; border-bottom: 2px solid #e5e7eb; }
        .form-section-subtitle { color: #6b7280; margin-bottom: 1.5rem; }
        .dynamic-input-container input { margin-bottom: 0.5rem; }

        /* Stili per la Stampa */
        @media print {
            body {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                margin: 0;
                padding: 0;
            }
            .no-print { display: none !important; }
            .printable-area {
                box-shadow: none !important;
                border: none !important;
                margin: 0 !important;
                padding: 1cm !important;
            }
            body.print-evaluation-only .form-section:not(#medical-evaluation-section, .patient-info-print-only, #important-message-section, #follow-up-section) { display: none !important; }
            body.print-evaluation-only .patient-info-print-only { display: block !important; }
            body.print-evaluation-only h1 { display: none !important; }
            .page-break { page-break-before: always; }
            .printable-data {
                display: block !important;
                background: none !important;
                border: none !important;
                padding: 0 !important;
                font-size: inherit !important;
                line-height: inherit !important;
                color: black !important;
                width: 100% !important;
                resize: none !important;
                overflow: hidden !important;
                -webkit-box-shadow: none !important;
                box-shadow: none !important;
                -webkit-text-fill-color: black !important;
                text-fill-color: black !important;
            }

            /* Assicura che i checkbox e le loro etichette vengano visualizzati */
            input[type="checkbox"] + label {
                display: inline-block !important;
            }
            
            /* Stili specifici per le textarea */
            textarea.printable-data {
                height: auto !important;
                min-height: unset !important;
                white-space: pre-wrap !important;
            }

            /* Stili per i contenitori */
            .p-4.border.rounded-lg, .p-4.border.rounded-lg.bg-gray-50 {
                border: 1px solid #ddd !important;
                padding: 0.5rem !important;
                margin-bottom: 0.5rem !important;
            }

            .form-section-title {
                margin-top: 1.5rem !important;
                margin-bottom: 0.5rem !important;
                padding-bottom: 0.25rem !important;
                border-bottom: 1px solid black !important;
                color: black !important;
                font-size: 1.2rem !important;
                page-break-after: avoid;
            }
            .form-section-subtitle { display: none !important; }
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">

    <div id="login-screen" class="fixed inset-0 bg-gray-900 bg-opacity-90 z-50 flex items-center justify-center transition-opacity duration-300">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-3xl font-bold text-center text-blue-700 mb-6">Accedi</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="login-email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="login-email" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                </div>
                <div class="mb-6">
                    <label for="login-password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="login-password" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                </div>
                <div id="login-error" class="text-red-500 text-sm mb-4 hidden"></div>
                <button type="submit" class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition">Accedi</button>
            </form>
        </div>
    </div>

    <header class="bg-blue-700 text-white p-6 shadow-md no-print sticky top-0 z-40">
        <div class="container mx-auto flex items-center justify-between">
            <h1 class="text-3xl font-bold">Cartella Clinica Veterinaria</h1>
            <div class="flex items-center space-x-4">
                <button id="new-card-btn" class="px-4 py-2 bg-blue-500 rounded-lg font-semibold hover:bg-blue-600 transition">Nuova Scheda</button>
                <button id="logout-btn" class="px-4 py-2 bg-red-500 rounded-lg font-semibold hover:bg-red-600 transition">Logout</button>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-6 flex-grow">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

            <div class="md:col-span-1">
                <div class="bg-white p-6 shadow-lg rounded-lg sticky top-24">
                    <h2 class="text-2xl font-bold mb-4 text-blue-700">Pazienti Salvati</h2>
                    <div id="patients-list" class="space-y-4">
                        <p class="text-gray-500">Effettua l'accesso per vedere i pazienti.</p>
                    </div>
                </div>
            </div>

            <div class="md:col-span-2">
                <form id="patient-form" class="space-y-8">
                    <div id="message-box" class="mt-4 text-center"></div>

                    <div id="patient-info-header-print" class="hidden text-center mb-8">
                        <h1 class="text-4xl font-bold text-blue-700"></h1>
                        <p class="text-gray-600 mt-2"></p>
                    </div>

                    <div class="form-section p-6 bg-white shadow-lg rounded-lg mb-8 printable-area">
                        <h2 class="form-section-title">Anagrafica Paziente</h2>
                        <p class="form-section-subtitle">Dati del paziente e del proprietario.</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div>
                                <label for="entryDate" class="block text-sm font-medium text-gray-700">Data Ingresso</label>
                                <input type="date" id="entryDate" name="entryDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50 printable-data">
                            </div>
                            <div>
                                <label for="ownerLastname" class="block text-sm font-medium text-gray-700">Cognome Proprietario *</label>
                                <input type="text" id="ownerLastname" name="ownerLastname" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50 printable-data">
                            </div>
                            <div>
                                <label for="phone" class="block text-sm font-medium text-gray-700">Telefono</label>
                                <input type="tel" id="phone" name="phone" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50 printable-data">
                            </div>
                            <div>
                                <label for="altContact" class="block text-sm font-medium text-gray-700">Contatto Alternativo</label>
                                <input type="text" id="altContact" name="altContact" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50 printable-data">
                            </div>
                            <div>
                                <label for="patientName" class="block text-sm font-medium text-gray-700">Nome Paziente *</label>
                                <input type="text" id="patientName" name="patientName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50 printable-data">
                            </div>
                            <div>
                                <label for="species" class="block text-sm font-medium text-gray-700">Specie *</label>
                                <input type="text" id="species" name="species" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50 printable-data">
                            </div>
                            <div>
                                <label for="sex" class="block text-sm font-medium text-gray-700">Sesso</label>
                                <select id="sex" name="sex" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50 printable-data">
                                    <option value="Maschio Intero">Maschio Intero</option>
                                    <option value="Maschio Castrato">Maschio Castrato</option>
                                    <option value="Femmina Intera">Femmina Intera</option>
                                    <option value="Femmina Sterilizzata">Femmina Sterilizzata</option>
                                </select>
                            </div>
                            <div>
                                <label for="age" class="block text-sm font-medium text-gray-700">Età</label>
                                <input type="text" id="age" name="age" placeholder="Es. 5 anni" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50 printable-data">
                            </div>
                            <div>
                                <label for="weight" class="block text-sm font-medium text-gray-700">Peso (kg) *</label>
                                <input type="number" step="0.1" id="weight" name="weight" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50 printable-data">
                            </div>
                            <div>
                                <label for="microchip" class="block text-sm font-medium text-gray-700">Microchip</label>
                                <input type="text" id="microchip" name="microchip" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50 printable-data">
                            </div>
                        </div>
                    </div>

                    <div id="important-message-section" class="form-section p-6 bg-white shadow-lg rounded-lg mb-8 printable-area">
                        <div class="flex items-center justify-between mb-4 no-print">
                            <h2 class="form-section-title mb-0 border-0">Messaggio Importante</h2>
                            <button id="add-important-message-btn" type="button" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">Aggiungi Messaggio</button>
                        </div>
                        <div id="important-message-container">
                            </div>
                    </div>

                    <div class="form-section p-6 bg-white shadow-lg rounded-lg mb-8 printable-area">
                        <h2 class="form-section-title">Motivo Ricovero e Terapia In Atto</h2>
                        <p class="form-section-subtitle">Informazioni sull'ingresso e terapie domiciliari.</p>
                        <div class="space-y-4">
                            <div>
                                <label for="reasonForHospitalization" class="block text-sm font-medium text-gray-700">Motivo del Ricovero</label>
                                <textarea id="reasonForHospitalization" name="reasonForHospitalization" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50 printable-data"></textarea>
                            </div>
                            <div>
                                <label for="homeTreatments" class="block text-sm font-medium text-gray-700">Terapie Domiciliari In Atto</label>
                                <textarea id="homeTreatments" name="homeTreatments" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50 printable-data"></textarea>
                            </div>
                            <div>
                                <label for="admissionTherapy" class="block text-sm font-medium text-gray-700">Terapia Iniziata al Ricovero</label>
                                <textarea id="admissionTherapy" name="admissionTherapy" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50 printable-data"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="form-section p-6 bg-white shadow-lg rounded-lg mb-8 printable-area">
                        <h2 class="form-section-title">Anamnesi e Stato Clinico</h2>
                        <p class="form-section-subtitle">Dati storici e valutazione clinica all'ingresso.</p>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="vaccinations" class="block text-sm font-medium text-gray-700">Vaccinazioni</label>
                                <select id="vaccinations" name="vaccinations" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50 printable-data conditional-select" data-other-container="vaccinations-other-container">
                                    <option value="Non eseguite">Non eseguite</option>
                                    <option value="Regolari">Regolari</option>
                                    <option value="Parziali/Non valide">Parziali/Non valide</option>
                                    <option value="Altro">Altro</option>
                                </select>
                            </div>
                            <div id="vaccinations-other-container" class="hidden">
                                <label for="vaccinations-other" class="block text-sm font-medium text-gray-700">Specifica</label>
                                <input type="text" id="vaccinations-other" name="vaccinations-other" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50 printable-data">
                            </div>
                            <div>
                                <label for="parasiteTreatments" class="block text-sm font-medium text-gray-700">Trattamenti Antiparassitari</label>
                                <select id="parasiteTreatments" name="parasiteTreatments" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50 printable-data conditional-select" data-other-container="parasite-treatments-other-container">
                                    <option value="No">No</option>
                                    <option value="Regolari">Regolari</option>
                                    <option value="Parziali">Parziali</option>
                                    <option value="Altro">Altro</option>
                                </select>
                            </div>
                            <div id="parasite-treatments-other-container" class="hidden">
                                <label for="parasite-treatments-other" class="block text-sm font-medium text-gray-700">Specifica</label>
                                <input type="text" id="parasite-treatments-other" name="parasite-treatments-other" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50 printable-data">
                            </div>
                        </div>
                        <div class="mt-4">
                            <label for="previousPathologies" class="block text-sm font-medium text-gray-700">Patologie pregresse/Terapie croniche</label>
                            <textarea id="previousPathologies" name="previousPathologies" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50 printable-data"></textarea>
                        </div>
                    </div>
                    
                    <div id="medical-evaluation-section" class="form-section p-6 bg-white shadow-lg rounded-lg mb-8 printable-area">
                        <h2 class="form-section-title">Valutazione Medica</h2>
                        <p class="form-section-subtitle">Stato clinico del paziente.</p>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div>
                                <label for="mentalState" class="block text-sm font-medium text-gray-700">Stato Mentale</label>
                                <select id="mentalState" name="mentalState" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50 printable-data conditional-select" data-other-container="mentalStateOtherContainer">
                                    <option value="Normale">Normale</option>
                                    <option value="Soporoso">Soporoso</option>
                                    <option value="Stuporoso">Stuporoso</option>
                                    <option value="Comatoso">Comatoso</option>
                                    <option value="Iperestesia">Iperestesia</option>
                                    <option value="Disorientato">Disorientato</option>
                                    <option value="Altro">Altro</option>
                                </select>
                            </div>
                            <div id="mentalStateOtherContainer" class="hidden">
                                <label for="mentalStateOther" class="block text-sm font-medium text-gray-700">Specifica</label>
                                <input type="text" id="mentalStateOther" name="mentalStateOther" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50 printable-data">
                            </div>
                            <div>
                                <label for="gait" class="block text-sm font-medium text-gray-700">Deambulazione</label>
                                <select id="gait" name="gait" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50 printable-data conditional-select" data-other-container="gaitOtherContainer">
                                    <option value="Normale">Normale</option>
                                    <option value="Atassia">Atassia</option>
                                    <option value="Paresi">Paresi</option>
                                    <option value="Pleasure">Pleasure</option>
                                    <option value="Recumbent">Recumbent</option>
                                    <option value="Altro">Altro</option>
                                </select>
                            </div>
                            <div id="gaitOtherContainer" class="hidden">
                                <label for="gaitOther" class="block text-sm font-medium text-gray-700">Specifica</label>
                                <input type="text" id="gaitOther" name="gaitOther" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50 printable-data">
                            </div>
                            <div>
                                <label for="temperature" class="block text-sm font-medium text-gray-700">Temperatura (°C)</label>
                                <input type="text" id="temperature" name="temperature" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50 printable-data">
                            </div>
                            <div>
                                <label for="capillaryRefillTime" class="block text-sm font-medium text-gray-700">Tempo di Riempimento Capillare</label>
                                <input type="text" id="capillaryRefillTime" name="capillaryRefillTime" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50 printable-data">
                            </div>
                            <div>
                                <label for="mucousMembranes" class="block text-sm font-medium text-gray-700">Mucose</label>
                                <input type="text" id="mucousMembranes" name="mucousMembranes" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50 printable-data">
                            </div>
                            <div>
                                <label for="hydration" class="block text-sm font-medium text-gray-700">Stato di Idratazione</label>
                                <select id="hydration" name="hydration" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50 printable-data">
                                    <option value="Normale">Normale</option>
                                    <option value="Lieve (<5%)">Lieve (&lt;5%)</option>
                                    <option value="Moderata (5-8%)">Moderata (5-8%)</option>
                                    <option value="Grave (>8%)">Grave (&gt;8%)</option>
                                </select>
                            </div>
                            <div>
                                <label for="lymphNodes" class="block text-sm font-medium text-gray-700">Linfonodi</label>
                                <select id="lymphNodes" name="lymphNodes" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50 printable-data conditional-select" data-other-container="lymphNodesOtherContainer">
                                    <option value="Normali">Normali</option>
                                    <option value="Aumentati">Aumentati</option>
                                    <option value="Altro">Altro</option>
                                </select>
                            </div>
                            <div id="lymphNodesOtherContainer" class="hidden">
                                <label for="lymphNodesOther" class="block text-sm font-medium text-gray-700">Specifica</label>
                                <input type="text" id="lymphNodesOther" name="lymphNodesOther" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50 printable-data">
                            </div>
                            <div>
                                <label for="abdominalPalpation" class="block text-sm font-medium text-gray-700">Palpazione Addominale</label>
                                <select id="abdominalPalpation" name="abdominalPalpation" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50 printable-data">
                                    <option value="Normale">Normale</option>
                                    <option value="Dolente">Dolente</option>
                                    <option value="Tesa">Tesa</option>
                                </select>
                            </div>
                            <div>
                                <label for="cardiacAuscultation" class="block text-sm font-medium text-gray-700">Auscultazione Cardiaca</label>
                                <select id="cardiacAuscultation" name="cardiacAuscultation" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50 printable-data">
                                    <option value="Normale">Normale</option>
                                    <option value="Soffio">Soffio</option>
                                    <option value="Aritmia">Aritmia</option>
                                </select>
                            </div>
                            <div>
                                <label for="pulmonaryAuscultation" class="block text-sm font-medium text-gray-700">Auscultazione Polmonare</label>
                                <select id="pulmonaryAuscultation" name="pulmonaryAuscultation" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50 printable-data">
                                    <option value="Normale">Normale</option>
                                    <option value="Rumori aggiunti">Rumori aggiunti</option>
                                </select>
                            </div>
                            <div class="col-span-1 sm:col-span-2 lg:col-span-3">
                                <label for="cns" class="block text-sm font-medium text-gray-700">SNC (Sistema Nervoso Centrale)</label>
                                <textarea id="cns" name="cns" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50 printable-data"></textarea>
                            </div>
                            <div class="col-span-1 sm:col-span-2 lg:col-span-3">
                                <label for="otherFindings" class="block text-sm font-medium text-gray-700">Altre Osservazioni</label>
                                <textarea id="otherFindings" name="otherFindings" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50 printable-data"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="form-section p-6 bg-white shadow-lg rounded-lg mb-8 no-print">
                        <h2 class="form-section-title">Esami da Eseguire</h2>
                        <p class="form-section-subtitle">Seleziona gli esami necessari per il paziente.</p>
                        <div id="exams-to-perform-list" class="space-y-2">
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div class="flex items-center space-x-2">
                                    <input type="checkbox" id="exam-cbc" name="exam-cbc" class="rounded text-blue-600 focus:ring-blue-500">
                                    <label for="exam-cbc" class="text-gray-700">Emocromo (CBC)</label>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <input type="checkbox" id="exam-biochem" name="exam-biochem" class="rounded text-blue-600 focus:ring-blue-500 conditional-checkbox" data-other-container="exam-biochem-other-container">
                                    <label for="exam-biochem" class="text-gray-700">Biochimico</label>
                                </div>
                                <div id="exam-biochem-other-container" class="hidden">
                                    <input type="text" id="exam-biochem-other" name="exam-biochem-other" placeholder="Specificare biochimico" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50">
                                </div>
                                <div class="flex items-center space-x-2">
                                    <input type="checkbox" id="exam-snap" name="exam-snap" class="rounded text-blue-600 focus:ring-blue-500 conditional-checkbox" data-other-container="exam-snap-other-container">
                                    <label for="exam-snap" class="text-gray-700">Snap Test</label>
                                </div>
                                <div id="exam-snap-other-container" class="hidden">
                                    <input type="text" id="exam-snap-other" name="exam-snap-other" placeholder="Specificare Snap Test" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50">
                                </div>
                                <div class="flex items-center space-x-2">
                                    <input type="checkbox" id="exam-urinalysis" name="exam-urinalysis" class="rounded text-blue-600 focus:ring-blue-500">
                                    <label for="exam-urinalysis" class="text-gray-700">Esame urine</label>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <input type="checkbox" id="exam-pucu" name="exam-pucu" class="rounded text-blue-600 focus:ring-blue-500">
                                    <label for="exam-pucu" class="text-gray-700">PU/CU</label>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <input type="checkbox" id="exam-rx" name="exam-rx" class="rounded text-blue-600 focus:ring-blue-500 conditional-checkbox" data-other-container="exam-rx-other-container">
                                    <label for="exam-rx" class="text-gray-700">Rx</label>
                                </div>
                                <div id="exam-rx-other-container" class="hidden">
                                    <input type="text" id="exam-rx-other" name="exam-rx-other" placeholder="Specificare Rx" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50">
                                </div>
                                <div class="flex items-center space-x-2">
                                    <input type="checkbox" id="exam-ultrasound" name="exam-ultrasound" class="rounded text-blue-600 focus:ring-blue-500">
                                    <label for="exam-ultrasound" class="text-gray-700">Ecografia</label>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <input type="checkbox" id="exam-ecofast" name="exam-ecofast" class="rounded text-blue-600 focus:ring-blue-500">
                                    <label for="exam-ecofast" class="text-gray-700">EcoFAST</label>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <input type="checkbox" id="exam-emogas" name="exam-emogas" class="rounded text-blue-600 focus:ring-blue-500">
                                    <label for="exam-emogas" class="text-gray-700">Emogas</label>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <input type="checkbox" id="exam-surgery" name="exam-surgery" class="rounded text-blue-600 focus:ring-blue-500 conditional-checkbox" data-other-container="exam-surgery-other-container">
                                    <label for="exam-surgery" class="text-gray-700">Chirurgia</label>
                                </div>
                                <div id="exam-surgery-other-container" class="hidden">
                                    <input type="text" id="exam-surgery-other" name="exam-surgery-other" placeholder="Specificare tipo di chirurgia" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50">
                                </div>
                                <div class="flex items-center space-x-2">
                                    <input type="checkbox" id="exam-lab" name="exam-lab" class="rounded text-blue-600 focus:ring-blue-500 conditional-checkbox" data-other-container="exam-lab-other-container">
                                    <label for="exam-lab" class="text-gray-700">Laboratorio</label>
                                </div>
                                <div id="exam-lab-other-container" class="hidden">
                                    <input type="text" id="exam-lab-other" name="exam-lab-other" placeholder="Specificare esame di laboratorio" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50">
                                </div>
                                <div class="flex items-center space-x-2">
                                    <input type="checkbox" id="exam-other" name="exam-other" class="rounded text-blue-600 focus:ring-blue-500 conditional-checkbox" data-other-container="exam-other-other-container">
                                    <label for="exam-other" class="text-gray-700">Altro</label>
                                </div>
                                <div id="exam-other-other-container" class="hidden">
                                    <input type="text" id="exam-other-other" name="exam-other-other" placeholder="Specificare altro esame" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50">
                                </div>
                            </div>
                        </div>
                        <div class="text-right mt-4">
                            <button id="add-custom-exam-btn" type="button" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition text-sm">Aggiungi Esame Personalizzato</button>
                        </div>
                    </div>

                    <div class="form-section p-6 bg-white shadow-lg rounded-lg mb-8 printable-area">
                        <h2 class="form-section-title">Esami Eseguiti</h2>
                        <p class="form-section-subtitle">Esiti degli esami eseguiti.</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="executed-exam-cbc" class="inline-flex items-center">
                                    <input type="checkbox" id="executed-exam-cbc" name="executed-exam-cbc" class="rounded text-blue-600">
                                    <span class="ml-2">Emocromo</span>
                                </label>
                            </div>
                            <div>
                                <label for="executed-exam-biochem" class="inline-flex items-center">
                                    <input type="checkbox" id="executed-exam-biochem" name="executed-exam-biochem" class="rounded text-blue-600">
                                    <span class="ml-2">Biochimico</span>
                                </label>
                            </div>
                            <div>
                                <label for="executed-exam-snap" class="inline-flex items-center">
                                    <input type="checkbox" id="executed-exam-snap" name="executed-exam-snap" class="rounded text-blue-600">
                                    <span class="ml-2">Snap Test</span>
                                </label>
                            </div>
                            <div>
                                <label for="executed-exam-urinalysis" class="inline-flex items-center">
                                    <input type="checkbox" id="executed-exam-urinalysis" name="executed-exam-urinalysis" class="rounded text-blue-600">
                                    <span class="ml-2">Esame urine</span>
                                </label>
                            </div>
                            <div>
                                <label for="executed-exam-pucu" class="inline-flex items-center">
                                    <input type="checkbox" id="executed-exam-pucu" name="executed-exam-pucu" class="rounded text-blue-600">
                                    <span class="ml-2">PU/CU</span>
                                </label>
                            </div>
                            <div>
                                <label for="executed-exam-rx" class="inline-flex items-center">
                                    <input type="checkbox" id="executed-exam-rx" name="executed-exam-rx" class="rounded text-blue-600">
                                    <span class="ml-2">Rx</span>
                                </label>
                            </div>
                            <div>
                                <label for="executed-exam-ultrasound" class="inline-flex items-center">
                                    <input type="checkbox" id="executed-exam-ultrasound" name="executed-exam-ultrasound" class="rounded text-blue-600">
                                    <span class="ml-2">Ecografia</span>
                                </label>
                            </div>
                            <div>
                                <label for="executed-exam-ecofast" class="inline-flex items-center">
                                    <input type="checkbox" id="executed-exam-ecofast" name="executed-exam-ecofast" class="rounded text-blue-600">
                                    <span class="ml-2">EcoFAST</span>
                                </label>
                            </div>
                            <div>
                                <label for="executed-exam-emogas" class="inline-flex items-center">
                                    <input type="checkbox" id="executed-exam-emogas" name="executed-exam-emogas" class="rounded text-blue-600">
                                    <span class="ml-2">Emogas</span>
                                </label>
                            </div>
                            <div>
                                <label for="executed-exam-surgery" class="inline-flex items-center">
                                    <input type="checkbox" id="executed-exam-surgery" name="executed-exam-surgery" class="rounded text-blue-600">
                                    <span class="ml-2">Chirurgia</span>
                                </label>
                            </div>
                            <div>
                                <label for="executed-exam-lab" class="inline-flex items-center">
                                    <input type="checkbox" id="executed-exam-lab" name="executed-exam-lab" class="rounded text-blue-600">
                                    <span class="ml-2">Laboratorio</span>
                                </label>
                            </div>
                        </div>
                        <div class="mt-4">
                            <label for="executed-exam-other-text" class="block text-sm font-medium text-gray-700">Altro (specificare)</label>
                            <textarea id="executed-exam-other-text" name="executed-exam-other-text" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50 printable-data"></textarea>
                        </div>
                    </div>

                    <div class="form-section p-6 bg-white shadow-lg rounded-lg mb-8 printable-area">
                        <h2 class="form-section-title">Terapia</h2>
                        <p class="form-section-subtitle">Terapie impostate in degenza.</p>
                        <div class="mt-4 space-y-4">
                            <div class="flex items-center justify-between mb-4 no-print">
                                <h3 class="font-semibold text-gray-700">Terapia Flebo (Flebo in Corso)</h3>
                                <button id="add-infusion-btn" type="button" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">Aggiungi Flebo</button>
                            </div>
                            <div id="dynamic-infusion-inputs">
                                </div>
                        </div>
                        <div class="mt-8 space-y-4">
                            <div class="flex items-center justify-between mb-4 no-print">
                                <h3 class="font-semibold text-gray-700">Terapia Farmaci (Farmaci da Somministrare)</h3>
                                <button id="add-drug-btn" type="button" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">Aggiungi Farmaco</button>
                            </div>
                            <div id="dynamic-drug-inputs" class="space-y-2">
                                </div>
                        </div>
                    </div>

                    <div class="form-section p-6 bg-white shadow-lg rounded-lg mb-8 printable-area">
                        <h2 class="form-section-title">Terapia (Somministrazioni)</h2>
                        <p class="form-section-subtitle">Terapie somministrate durante la degenza.</p>

                        <div class="flex items-center justify-between mb-4 no-print">
                            <h3 class="font-semibold text-gray-700">Somministrazioni Farmaci</h3>
                            <button id="add-therapy-log-btn" type="button" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">Aggiungi Somministrazione</button>
                        </div>
                        <div id="therapy-log-container" class="space-y-4">
                            </div>

                        <div class="flex items-center justify-between my-4 no-print">
                            <h3 class="font-semibold text-gray-700">Fluidoterapia</h3>
                            <button id="add-fluid-therapy-btn" type="button" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">Aggiungi Fluidoterapia</button>
                        </div>
                        <div id="fluid-therapy-container" class="space-y-4">
                            </div>
                    </div>


                    <div class="form-section p-6 bg-white shadow-lg rounded-lg mb-8 printable-area">
                        <h2 class="form-section-title">Decorsi e Condizioni alla dimissione</h2>
                        <p class="form-section-subtitle">Note sull'andamento della degenza e condizioni alla dimissione.</p>
                        <div class="space-y-4">
                            <div>
                                <label for="medicalCourse" class="block text-sm font-medium text-gray-700">Decorsi</label>
                                <textarea id="medicalCourse" name="medicalCourse" rows="5" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50 printable-data"></textarea>
                            </div>
                            <div>
                                <label for="dischargeConditions" class="block text-sm font-medium text-gray-700">Condizioni alla dimissione</label>
                                <textarea id="dischargeConditions" name="dischargeConditions" rows="5" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50 printable-data"></textarea>
                            </div>
                            <div>
                                <label for="homeTherapy" class="block text-sm font-medium text-gray-700">Terapia domiciliare</label>
                                <textarea id="homeTherapy" name="homeTherapy" rows="5" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50 printable-data"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div id="follow-up-section" class="form-section p-6 bg-white shadow-lg rounded-lg mb-8 printable-area">
                        <h2 class="form-section-title">Follow-up</h2>
                        <p class="form-section-subtitle">Indicazioni e controlli successivi.</p>
                        <div class="relative mt-2 rounded-md shadow-sm">
                            <textarea id="followUp" name="followUp" rows="5" class="printable-data block w-full rounded-md border-gray-300 p-4 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="Indicazioni per il follow-up del paziente..."></textarea>
                        </div>
                    </div>

                    <div class="flex justify-between items-center space-x-4 mt-8 no-print sticky bottom-0 z-40 bg-gray-100 p-4 rounded-t-lg shadow-lg">
                        <button type="button" id="print-button" class="flex-1 px-6 py-3 bg-green-500 text-white rounded-lg font-semibold hover:bg-green-600 transition">Stampa Cartella Completa</button>
                        <button type="button" id="print-evaluation-button" class="flex-1 px-6 py-3 bg-yellow-500 text-white rounded-lg font-semibold hover:bg-yellow-600 transition">Stampa Valutazione</button>
                        <button type="button" id="save-button" class="flex-1 px-6 py-3 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600 transition">Salva Paziente</button>
                    </div>

                </form>
            </div>
        </div>
    </main>

    <div id="templates" class="hidden">
        <div id="infusion-row-template" class="p-4 border rounded-lg bg-gray-50 relative">
            <button type="button" class="remove-infusion-btn absolute top-2 right-2 text-red-500 hover:text-red-700 transition">&times;</button>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label class="text-sm font-medium text-gray-700">Tipo di Flebo</label>
                    <input type="text" data-field="infusionType" placeholder="Es. Flebo ringer lattato" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-white printable-data">
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-700">Velocità di Infusione</label>
                    <input type="text" data-field="infusionRate" placeholder="Es. 10 ml/kg/h" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-white printable-data">
                </div>
                <div class="col-span-1 sm:col-span-2">
                    <label class="text-sm font-medium text-gray-700">Additivi</label>
                    <input type="text" data-field="additives" placeholder="Es. KCl, Vitamina B" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-white printable-data">
                </div>
            </div>
        </div>

        <div id="therapy-log-template" class="p-4 border rounded-lg bg-gray-50 relative">
            <button type="button" class="remove-entry-btn absolute top-2 right-2 text-red-500 hover:text-red-700 transition">&times;</button>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label class="text-sm font-medium text-gray-700">Data e Ora</label>
                    <input type="datetime-local" data-field="timestamp" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-white printable-data">
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-700">Farmaco</label>
                    <input type="text" data-field="drugName" placeholder="Nome farmaco..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-white printable-data">
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-700">Dose</label>
                    <input type="text" data-field="dose" placeholder="Dose somministrata..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-white printable-data">
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-700">Via</label>
                    <input type="text" data-field="route" placeholder="Via di somministrazione..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-white printable-data">
                </div>
            </div>
        </div>

        <div id="monitoring-entry-template" class="p-4 border rounded-lg bg-gray-50 relative">
            <button type="button" class="remove-entry-btn absolute top-2 right-2 text-red-500 hover:text-red-700 transition">&times;</button>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label class="text-sm font-medium text-gray-700">Data e Ora</label>
                    <input type="datetime-local" data-field="timestamp" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-white printable-data">
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-700">Temperatura (°C)</label>
                    <input type="text" data-field="temperature" placeholder="Temperatura..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-white printable-data">
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-700">Stato Mentale</label>
                    <input type="text" data-field="mentalState" placeholder="Es. vigilante, depresso" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-white printable-data">
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-700">Osservazioni</label>
                    <input type="text" data-field="observations" placeholder="Altre osservazioni..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-white printable-data">
                </div>
            </div>
        </div>

        <div id="important-message-template" class="p-4 border rounded-lg bg-yellow-100 border-yellow-300 relative">
            <h3 class="font-bold text-lg text-yellow-800">⚠ Messaggio Importante</h3>
            <button type="button" class="remove-important-message-btn absolute top-2 right-2 text-red-500 hover:text-red-700 transition">&times;</button>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-2">
                <div>
                    <label class="block text-sm font-medium text-yellow-800">Data Inizio</label>
                    <input type="date" data-field="startDate" class="mt-1 block w-full rounded-md border-yellow-300 p-2 printable-data">
                </div>
                <div>
                    <label class="block text-sm font-medium text-yellow-800">Data Fine</label>
                    <input type="date" data-field="endDate" class="mt-1 block w-full rounded-md border-yellow-300 p-2 printable-data">
                </div>
                <div class="sm:col-span-2">
                    <label class="block text-sm font-medium text-yellow-800">Messaggio</label>
                    <textarea data-field="messageText" rows="3" class="mt-1 block w-full rounded-md border-yellow-300 p-2 printable-data"></textarea>
                </div>
            </div>
        </div>

        <div id="custom-exam-template" class="flex items-center space-x-2 custom-exam-item hidden">
            <input type="checkbox" class="rounded text-blue-600 focus:ring-blue-500 exam-checkbox">
            <input type="text" class="custom-exam-name flex-grow block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50 printable-data" placeholder="Nome esame personalizzato...">
            <button type="button" class="remove-custom-exam-btn text-red-500 hover:text-red-700 transition text-lg font-bold">&times;</button>
        </div>

        <div id="fluid-therapy-template" class="hidden p-4 border rounded-lg bg-gray-50 relative">
            <button type="button" class="remove-entry-btn absolute top-2 right-2 text-red-500 hover:text-red-700 transition no-print">&times;</button>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="flex flex-col">
                    <label class="text-sm font-medium text-gray-700">Data</label>
                    <input type="date" data-field="date" class="w-full px-4 py-2 bg-white border rounded-lg printable-data">
                </div>
                <div class="flex flex-col">
                    <label class="text-sm font-medium text-gray-700">Ora</label>
                    <input type="time" data-field="time" class="w-full px-4 py-2 bg-white border rounded-lg printable-data">
                </div>
                <div class="flex flex-col">
                    <label class="text-sm font-medium text-gray-700">Operatore</label>
                    <input type="text" data-field="operator" placeholder="Nome operatore..." class="w-full px-4 py-2 bg-white border rounded-lg printable-data">
                </div>
                <div class="flex flex-col">
                    <label class="text-sm font-medium text-gray-700">Tipo di Flebo</label>
                    <input type="text" data-field="infusionType" placeholder="Es. NaCl 0.9%..." class="w-full px-4 py-2 bg-white border rounded-lg printable-data">
                </div>
                <div class="flex flex-col">
                    <label class="text-sm font-medium text-gray-700">Volume</label>
                    <input type="text" data-field="volume" placeholder="Es. 250 ml" class="w-full px-4 py-2 bg-white border rounded-lg printable-data">
                </div>
                <div class="flex flex-col">
                    <label class="text-sm font-medium text-gray-700">Via</label>
                    <input type="text" data-field="route" placeholder="Es. EV" class="w-full px-4 py-2 bg-white border rounded-lg printable-data">
                </div>
                <div class="flex flex-col">
                    <label class="text-sm font-medium text-gray-700">Velocità</label>
                    <select data-field="speed" class="w-full px-4 py-2 bg-white border rounded-lg printable-data">
                        <option value="bolo lento">bolo lento</option>
                        <option value="bolo veloce">bolo veloce</option>
                        <option value="goccia lenta">goccia lenta</option>
                        <option value="goccia veloce">goccia veloce</option>
                        <option value="pompa infusione">pompa infusione</option>
                    </select>
                </div>
                <div class="flex flex-col">
                    <label class="text-sm font-medium text-gray-700">Pompa infusione ml/kg/h</label>
                    <input type="text" data-field="pumpSpeed" placeholder="Es. 5 ml/kg/h" class="w-full px-4 py-2 bg-white border rounded-lg printable-data">
                </div>
            </div>
            <div class="mt-4">
                <label class="text-sm font-medium text-gray-700">Note</label>
                <textarea data-field="notes" rows="2" class="w-full px-4 py-2 bg-white border rounded-lg printable-data" placeholder="Note sulla somministrazione..."></textarea>
            </div>
        </div>
    </div>


    <script>
        // --- Riferimenti a Firebase Authentication e Firestore ---
        const auth = firebase.auth();
        const db = firebase.firestore();
        const patientsCollection = db.collection('patients'); // Una "collezione" dove salveremo i pazienti

        // --- ELEMENTI DEL DOM ---
        const patientForm = document.getElementById('patient-form');
        const messageBox = document.getElementById('message-box');
        const patientsListDiv = document.getElementById('patients-list');
        const saveButton = document.getElementById('save-button');
        const examsToPerformList = document.getElementById('exams-to-perform-list');
        const infusionContainer = document.getElementById('dynamic-infusion-inputs');
        const drugsContainer = document.getElementById('dynamic-drug-inputs');
        const importantMessageContainer = document.getElementById('important-message-container');

        // Elementi di autenticazione
        const loginScreen = document.getElementById('login-screen');
        const loginForm = document.getElementById('login-form');
        const loginEmail = document.getElementById('login-email');
        const loginPassword = document.getElementById('login-password');
        const loginError = document.getElementById('login-error');
        const logoutBtn = document.getElementById('logout-btn');

        // Nuovo contenitore per la fluidoterapia
        const fluidTherapyContainer = document.getElementById('fluid-therapy-container');

        let currentPatientId = null;

        // --- FUNZIONI DI BASE ---
        function displayMessage(text, type) {
            messageBox.textContent = text;
            messageBox.className = `mt-4 text-center p-3 rounded-lg ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
            setTimeout(() => { messageBox.textContent = ''; messageBox.className = 'mt-4 text-center'; }, 5000);
        }

        function clearForm() {
            patientForm.reset();
            currentPatientId = null;
            document.querySelectorAll('.hidden[id*="-other-container"], .hidden[data-id*="-container"]').forEach(el => el.style.display = 'none');
            document.getElementById('monitoring-entries-container').innerHTML = '';
            document.getElementById('therapy-log-container').innerHTML = '';
            fluidTherapyContainer.innerHTML = ''; // Pulisce il nuovo contenitore
            importantMessageContainer.innerHTML = '';

            infusionContainer.innerHTML = '';
            const defaultInfusion = document.getElementById('infusion-row-template').cloneNode(true);
            defaultInfusion.id = '';
            defaultInfusion.classList.remove('hidden');
            infusionContainer.appendChild(defaultInfusion);

            drugsContainer.innerHTML = '';
            const defaultDrug = document.createElement('input');
            defaultDrug.type = 'text';
            defaultDrug.placeholder = 'Nome farmaco...';
            defaultDrug.className = 'w-full px-4 py-2 bg-gray-50 border rounded-lg printable-data';
            drugsContainer.appendChild(defaultDrug);

            // Rimuove gli esami personalizzati
            document.querySelectorAll('.custom-exam-item').forEach(el => el.remove());

            saveButton.textContent = 'Salva Paziente';
            document.getElementById('entryDate').valueAsDate = new Date();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        document.getElementById('new-card-btn').addEventListener('click', clearForm);

        // --- GESTIONE CAMPI CONDIZIONALI ---
        function handleConditionalVisibility(element) {
            const containerId = element.dataset.otherContainer;
            if (!containerId) return;
            const container = document.getElementById(containerId);
            if (!container) return;

            const isCheckbox = element.type === 'checkbox';
            let shouldShow;

            if (isCheckbox) {
                shouldShow = element.checked;
            } else {
                const conditionValue = element.dataset.conditionValue || 'Altro';
                shouldShow = element.value === conditionValue;
            }

            container.style.display = shouldShow ? '' : 'none';
            if (!shouldShow) {
                container.querySelectorAll('input, textarea').forEach(input => input.value = '');
            }
        }
        document.body.addEventListener('change', (e) => {
            if (e.target.matches('.conditional-select') || e.target.matches('.conditional-checkbox')) {
                handleConditionalVisibility(e.target);
            }
        });

        // --- GESTIONE SEZIONI DINAMICHE (MONITORAGGIO/TERAPIA) ---
        function setupDynamicSection(buttonId, containerId, templateId) {
            document.getElementById(buttonId).addEventListener('click', () => {
                const template = document.getElementById(templateId);
                const clone = template.cloneNode(true);
                clone.id = '';
                clone.classList.remove('hidden');
                document.getElementById(containerId).appendChild(clone);
            });
            document.getElementById(containerId).addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-entry-btn') || e.target.classList.contains('remove-infusion-btn')) {
                    const parent = e.target.closest('.p-4.border.rounded-lg');
                    if (parent) {
                        parent.remove();
                    }
                }
            });
        }
        setupDynamicSection('add-monitoring-btn', 'monitoring-entries-container', 'monitoring-entry-template');
        setupDynamicSection('add-therapy-log-btn', 'therapy-log-container', 'therapy-log-template');

        // Nuovo setup per la fluidoterapia
        setupDynamicSection('add-fluid-therapy-btn', 'fluid-therapy-container', 'fluid-therapy-template');

        // --- GESTIONE AGGIUNTA FLEBO (vecchio) ---
        document.getElementById('add-infusion-btn').addEventListener('click', () => {
            const template = document.getElementById('infusion-row-template');
            const clone = template.cloneNode(true);
            clone.id = '';
            clone.classList.remove('hidden');
            infusionContainer.appendChild(clone);
        });

        // --- GESTIONE AGGIUNTA FARMACI ---
        document.getElementById('add-drug-btn').addEventListener('click', () => {
            const newInput = document.createElement('input');
            newInput.type = 'text';
            newInput.placeholder = 'Nome farmaco...';
            newInput.className = 'w-full px-4 py-2 bg-gray-50 border rounded-lg printable-data';
            drugsContainer.appendChild(newInput);
            newInput.focus();
        });

        drugsContainer.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('add-drug-btn').click();
            }
        });

        // --- GESTIONE AGGIUNTA ESAMI PERSONALIZZATI ---
        document.getElementById('add-custom-exam-btn').addEventListener('click', () => {
            const customExamTemplate = document.getElementById('custom-exam-template');
            const clone = customExamTemplate.cloneNode(true);
            clone.classList.add('custom-exam-item');
            clone.classList.remove('hidden');
            examsToPerformList.appendChild(clone);
        });

        examsToPerformList.addEventListener('click', (e) => {
            if(e.target.classList.contains('remove-custom-exam-btn')) {
                e.target.closest('.custom-exam-item').remove();
            }
        });

        // --- GESTIONE MESSAGGIO IMPORTANTE ---
        function addImportantMessage(messageData = {}) {
            const template = document.getElementById('important-message-template');
            const clone = template.cloneNode(true);
            clone.id = '';
            clone.classList.remove('hidden');

            const today = new Date().toISOString().split('T')[0];
            const endDate = new Date(messageData.endDate);
            const isExpired = endDate < new Date();

            if (!isExpired) {
                 importantMessageContainer.appendChild(clone);

                 // Popola i campi se i dati sono stati forniti
                 if (Object.keys(messageData).length > 0) {
                     clone.querySelector('[data-field="startDate"]').value = messageData.startDate;
                     clone.querySelector('[data-field="endDate"]').value = messageData.endDate;
                     clone.querySelector('[data-field="messageText"]').value = messageData.messageText;
                 } else {
                    clone.querySelector('[data-field="startDate"]').value = today;
                 }
            } else {
                console.log("Messaggio scaduto, non aggiunto al DOM.");
            }
        }

        document.getElementById('add-important-message-btn').addEventListener('click', () => {
            if (importantMessageContainer.children.length === 0) {
                addImportantMessage({});
            } else {
                displayMessage("È già presente un messaggio importante. Rimuovilo per aggiungerne un altro.", "error");
            }
        });

        importantMessageContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-important-message-btn')) {
                e.target.closest('.p-4.border.rounded-lg').remove();
            }
        });

        // --- GESTIONE STAMPA ---
        let originalTextareas = [];

        window.onbeforeprint = () => {
            // Nasconde il header solo nella stampa
            document.getElementById('patient-info-header-print').classList.remove('hidden');

            // Sostituisce le textarea con <div> per la stampa
            document.querySelectorAll('textarea.printable-data').forEach(textarea => {
                const replacementDiv = document.createElement('div');
                replacementDiv.classList.add('printable-data', 'print-only-content');
                replacementDiv.textContent = textarea.value;
                textarea.style.display = 'none'; // Nasconde la textarea originale
                textarea.parentNode.insertBefore(replacementDiv, textarea.nextSibling);
                originalTextareas.push({ textarea: textarea, replacement: replacementDiv });
            });
        };

        window.onafterprint = () => {
            // Ripristina l'interfaccia rimuovendo i <div> e mostrando le textarea
            originalTextareas.forEach(item => {
                item.replacement.remove();
                item.textarea.style.display = '';
            });
            originalTextareas = [];

            // Nasconde il header dopo la stampa
            document.getElementById('patient-info-header-print').classList.add('hidden');
        };

        document.getElementById('print-button').addEventListener('click', () => {
            document.body.classList.remove('print-evaluation-only');
            document.querySelector('#patient-info-header-print h1').textContent = `Cartella Clinica: ${document.getElementById('patientName').value || 'N/D'} (${document.getElementById('ownerLastname').value || 'N/D'})`;
            document.querySelector('#patient-info-header-print p').textContent = `Data di Stampa: ${new Date().toLocaleDateString('it-IT')}`;
            window.print();
        });

        document.getElementById('print-evaluation-button').addEventListener('click', () => {
            document.body.classList.add('print-evaluation-only');
            document.querySelector('#patient-info-header-print h1').textContent = `Valutazione Medica: ${document.getElementById('patientName').value || 'N/D'} (${document.getElementById('ownerLastname').value || 'N/D'})`;
            document.querySelector('#patient-info-header-print p').textContent = `Data di Stampa: ${new Date().toLocaleDateString('it-IT')}`;
            window.print();
        });

        // --- GESTIONE AUTHENTICATION E FIREBASE ---
        auth.onAuthStateChanged(user => {
            if (user) {
                // L'utente è loggato
                loginScreen.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
                renderPatientsList();
            } else {
                // L'utente non è loggato
                loginScreen.classList.remove('hidden');
                document.body.classList.add('overflow-hidden');
                patientsListDiv.innerHTML = '<p class="text-gray-500">Effettua l\'accesso per vedere i pazienti.</p>';
                clearForm();
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                await auth.signInWithEmailAndPassword(loginEmail.value, loginPassword.value);
                loginError.classList.add('hidden');
            } catch (error) {
                console.error("Login fallito:", error);
                loginError.textContent = "Credenziali non valide. Riprova.";
                loginError.classList.remove('hidden');
            }
        });

        logoutBtn.addEventListener('click', async () => {
            await auth.signOut();
        });

        // --- CARICAMENTO, POPOLAMENTO E SALVATAGGIO DATI (FIREBASE) ---
        async function renderPatientsList() {
            const patientsListDiv = document.getElementById('patients-list');
            patientsListDiv.innerHTML = '<p id="loading-patients" class="text-gray-500">Caricamento pazienti...</p>';

            try {
                const snapshot = await patientsCollection.orderBy('updatedAt', 'desc').get();
                const patientsArray = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                patientsListDiv.innerHTML = '';
                if (patientsArray.length === 0) {
                    patientsListDiv.innerHTML = '<p class="text-gray-500">Nessun paziente salvato.</p>';
                    return;
                }

                patientsArray.forEach(patient => {
                    const patientCard = document.createElement('div');
                    patientCard.className = 'p-4 border rounded-lg bg-gray-50 flex flex-col sm:flex-row justify-between sm:items-center';
                    patientCard.innerHTML = `
                        <div>
                            <p class="font-bold text-lg text-blue-700">${patient.patientName || 'N/D'} <span class="text-sm font-normal text-gray-500">(${patient.species || 'N/D'})</span></p>
                            <p class="text-gray-600">Proprietario: ${patient.ownerLastname || 'N/D'}</p>
                            <p class="text-xs text-gray-400 mt-1">Ultima modifica: ${new Date(patient.updatedAt.toDate()).toLocaleString('it-IT')}</p>
                        </div>
                        <div class="flex space-x-2 mt-3 sm:mt-0">
                            <button data-id="${patient.id}" class="open-patient-btn px-4 py-2 bg-white border border-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-100 transition">Apri</button>
                            <button data-id="${patient.id}" class="delete-patient-btn px-4 py-2 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 transition">Elimina</button>
                        </div>
                    `;
                    patientsListDiv.appendChild(patientCard);
                });
            } catch (error) {
                console.error("Errore nel caricamento dei pazienti:", error);
                patientsListDiv.innerHTML = '<p class="text-red-500">Errore nel caricamento dei dati.</p>';
            }
        }

        patientsListDiv.addEventListener('click', (e) => {
            if (e.target.classList.contains('open-patient-btn')) {
                loadPatientData(e.target.dataset.id);
            }
            if (e.target.classList.contains('delete-patient-btn')) {
                deletePatientData(e.target.dataset.id);
            }
        });

        async function loadPatientData(id) {
            try {
                const doc = await patientsCollection.doc(id).get();
                if (doc.exists) {
                    clearForm();
                    populateForm(doc.data());
                    currentPatientId = doc.id;
                    saveButton.textContent = 'Aggiorna Scheda';
                    displayMessage(`Scheda di ${doc.data().patientName} caricata.`, 'success');
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } else {
                    displayMessage("Paziente non trovato.", "error");
                }
            } catch (error) {
                console.error("Errore nel caricamento del paziente:", error);
                displayMessage("Errore nel caricamento dei dati.", "error");
            }
        }


        function populateForm(data) {
            // Popola i campi statici
            const formElements = document.querySelectorAll('#patient-form [id]');
            formElements.forEach(el => {
                const key = el.id;
                if (data.hasOwnProperty(key)) {
                    if (el.type === 'checkbox') {
                        el.checked = data[key];
                    } else if (el.tagName === 'SELECT') {
                        el.value = data[key] || el.options[0].value;
                    } else {
                        el.value = data[key] || '';
                    }
                }
            });

            // Gestisce i campi "other"
            document.querySelectorAll('.conditional-select').forEach(el => {
                el.dispatchEvent(new Event('change'));
            });

            // Popola gli esami da eseguire
            if (data.examsToPerform) {
                document.getElementById('exam-cbc').checked = data.examsToPerform.cbc;
                document.getElementById('exam-biochem').checked = data.examsToPerform.biochem;
                document.getElementById('exam-biochem-other').value = data.examsToPerform.biochem_other || '';
                document.getElementById('exam-snap').checked = data.examsToPerform.snap;
                document.getElementById('exam-snap-other').value = data.examsToPerform.snap_other || '';
                document.getElementById('exam-urinalysis').checked = data.examsToPerform.urinalysis;
                document.getElementById('exam-pucu').checked = data.examsToPerform.pucu;
                document.getElementById('exam-rx').checked = data.examsToPerform.rx;
                document.getElementById('exam-rx-other').value = data.examsToPerform.rx_other || '';
                document.getElementById('exam-ultrasound').checked = data.examsToPerform.ultrasound;
                document.getElementById('exam-ecofast').checked = data.examsToPerform.ecofast;
                document.getElementById('exam-emogas').checked = data.examsToPerform.emogas;
                document.getElementById('exam-surgery').checked = data.examsToPerform.surgery;
                document.getElementById('exam-surgery-other').value = data.examsToPerform.surgery_other || '';
                document.getElementById('exam-lab').checked = data.examsToPerform.lab;
                document.getElementById('exam-lab-other').value = data.examsToPerform.lab_other || '';
                document.getElementById('exam-other').checked = data.examsToPerform.other;
                document.getElementById('exam-other-other').value = data.examsToPerform.other_other || '';
            }

            if (data.customExams) {
                // Rimuove i vecchi esami custom prima di aggiungerli
                document.querySelectorAll('.custom-exam-item').forEach(el => el.remove());
                data.customExams.forEach(exam => {
                    const template = document.getElementById('custom-exam-template');
                    const clone = template.cloneNode(true);
                    clone.classList.remove('hidden');
                    const checkbox = clone.querySelector('.exam-checkbox');
                    const nameInput = clone.querySelector('.custom-exam-name');
                    checkbox.checked = exam.checked;
                    nameInput.value = exam.name || '';
                    examsToPerformList.appendChild(clone);
                });
            }

            // Popola gli esami eseguiti
            if (data.examsExecuted) {
                document.getElementById('executed-exam-cbc').checked = data.examsExecuted.cbc;
                document.getElementById('executed-exam-biochem').checked = data.examsExecuted.biochem;
                document.getElementById('executed-exam-biochem-other').value = data.examsExecuted.biochem_other || '';
                document.getElementById('executed-exam-snap').checked = data.examsExecuted.snap;
                document.getElementById('executed-exam-urinalysis').checked = data.examsExecuted.urinalysis;
                document.getElementById('executed-exam-pucu').checked = data.examsExecuted.pucu;
                document.getElementById('executed-exam-rx').checked = data.examsExecuted.rx;
                document.getElementById('executed-exam-ultrasound').checked = data.examsExecuted.ultrasound;
                document.getElementById('executed-exam-ecofast').checked = data.examsExecuted.ecofast;
                document.getElementById('executed-exam-emogas').checked = data.examsExecuted.emogas;
                document.getElementById('executed-exam-surgery').checked = data.examsExecuted.surgery;
                document.getElementById('executed-exam-lab').checked = data.examsExecuted.lab;
                document.getElementById('executed-exam-other-text').value = data.examsExecuted.other_text || '';
            }

            // Popola le sezioni dinamiche (flebo, monitoraggio, terapia, messaggio)
            const populateDynamicSection = (containerId, templateId, entries) => {
                const container = document.getElementById(containerId);
                container.innerHTML = '';
                (entries || []).forEach(entryData => {
                    const template = document.getElementById(templateId);
                    const clone = template.cloneNode(true);
                    clone.id = '';
                    clone.classList.remove('hidden');
                    clone.querySelectorAll('[data-field]').forEach(input => {
                        if (input.type === 'checkbox') {
                            input.checked = entryData[input.dataset.field];
                        } else if (input.tagName === 'SELECT') {
                            input.value = entryData[input.dataset.field] || input.options[0].value;
                        } else {
                            input.value = entryData[input.dataset.field] || '';
                        }
                    });
                    container.appendChild(clone);
                });
                // Assicura che ci sia sempre almeno un campo di default se la sezione era vuota
                if (container.children.length === 0 && templateId !== 'custom-exam-template' && templateId !== 'important-message-template') {
                    const defaultClone = document.getElementById(templateId).cloneNode(true);
                    defaultClone.id = '';
                    defaultClone.classList.remove('hidden');
                    container.appendChild(defaultClone);
                }
            };

            // Flebo
            populateDynamicSection('dynamic-infusion-inputs', 'infusion-row-template', data.infusionTherapy);
            // Farmaci
            const drugsContainer = document.getElementById('dynamic-drug-inputs');
            drugsContainer.innerHTML = '';
            (data.drugsToAdminister || []).forEach(drug => {
                const drugInput = document.createElement('input');
                drugInput.type = 'text';
                drugInput.placeholder = 'Nome farmaco...';
                drugInput.className = 'w-full px-4 py-2 bg-gray-50 border rounded-lg printable-data';
                drugInput.value = drug;
                drugsContainer.appendChild(drugInput);
            });
            const emptyInput = document.createElement('input');
            emptyInput.type = 'text';
            emptyInput.placeholder = 'Nome farmaco...';
            emptyInput.className = 'w-full px-4 py-2 bg-gray-50 border rounded-lg printable-data';
            drugsContainer.appendChild(emptyInput);

            // Messaggio importante
            importantMessageContainer.innerHTML = '';
            if (data.importantMessage) {
                 addImportantMessage(data.importantMessage);
            }

            // Monitoraggio e terapia log
            populateDynamicSection('monitoring-entries-container', 'monitoring-entry-template', data.monitoringEntries);
            populateDynamicSection('therapy-log-container', 'therapy-log-template', data.therapyLog);
            // Nuova sezione: fluidoterapia
            populateDynamicSection('fluid-therapy-container', 'fluid-therapy-template', data.fluidTherapyEntries);
        }


        async function saveData() {
            const getDynamicEntries = (containerId) => {
                return Array.from(document.querySelectorAll(`#${containerId} > div:not(.hidden)`)).map(entryDiv => {
                    const entryData = {};
                    entryDiv.querySelectorAll('[data-field]').forEach(input => {
                        entryData[input.dataset.field] = input.type === 'checkbox' ? input.checked : input.value;
                    });
                    return entryData;
                });
            };

            const customExams = Array.from(document.querySelectorAll('.custom-exam-item')).map(item => {
                const checkbox = item.querySelector('.exam-checkbox');
                const nameInput = item.querySelector('.custom-exam-name');
                return {
                    name: nameInput.value.trim(),
                    checked: checkbox.checked
                };
            }).filter(exam => exam.name);

            // Ottiene i dati del messaggio importante
            const importantMessageElement = importantMessageContainer.querySelector('div:not(.hidden)');
            const importantMessageData = importantMessageElement ? {
                 startDate: importantMessageElement.querySelector('[data-field="startDate"]').value,
                 endDate: importantMessageElement.querySelector('[data-field="endDate"]').value,
                 messageText: importantMessageElement.querySelector('[data-field="messageText"]').value,
            } : null;

            const patientData = {
                entryDate: document.getElementById('entryDate').value,
                ownerLastname: document.getElementById('ownerLastname').value.trim(),
                phone: document.getElementById('phone').value.trim(),
                altContact: document.getElementById('altContact').value.trim(),
                patientName: document.getElementById('patientName').value.trim(),
                species: document.getElementById('species').value.trim(),
                sex: document.getElementById('sex').value,
                age: document.getElementById('age').value.trim(),
                weight: document.getElementById('weight').value,
                microchip: document.getElementById('microchip').value.trim(),
                reasonForHospitalization: document.getElementById('reasonForHospitalization').value.trim(),
                vaccinations: document.getElementById('vaccinations').value,
                vaccinationsOther: document.getElementById('vaccinations-other').value.trim(),
                parasiteTreatments: document.getElementById('parasiteTreatments').value,
                parasiteTreatmentsOther: document.getElementById('parasite-treatments-other').value.trim(),
                previousPathologies: document.getElementById('previousPathologies').value.trim(),
                mentalState: document.getElementById('mentalState').value,
                mentalStateOther: document.getElementById('mentalStateOther').value.trim(),
                gait: document.getElementById('gait').value,
                gaitOther: document.getElementById('gaitOther').value.trim(),
                temperature: document.getElementById('temperature').value,
                capillaryRefillTime: document.getElementById('capillaryRefillTime').value,
                mucousMembranes: document.getElementById('mucousMembranes').value.trim(),
                hydration: document.getElementById('hydration').value,
                lymphNodes: document.getElementById('lymphNodes').value,
                lymphNodesOther: document.getElementById('lymphNodesOther').value.trim(),
                abdominalPalpation: document.getElementById('abdominalPalpation').value,
                cardiacAuscultation: document.getElementById('cardiacAuscultation').value,
                pulmonaryAuscultation: document.getElementById('pulmonaryAuscultation').value,
                cns: document.getElementById('cns').value.trim(),
                otherFindings: document.getElementById('otherFindings').value.trim(),
                homeTreatments: document.getElementById('homeTreatments').value.trim(),
                admissionTherapy: document.getElementById('admissionTherapy').value.trim(),
                examsToPerform: {
                    cbc: document.getElementById('exam-cbc').checked,
                    biochem: document.getElementById('exam-biochem').checked, biochem_other: document.getElementById('exam-biochem-other').value.trim(),
                    snap: document.getElementById('exam-snap').checked, snap_other: document.getElementById('exam-snap-other').value.trim(),
                    urinalysis: document.getElementById('exam-urinalysis').checked, pucu: document.getElementById('exam-pucu').checked,
                    rx: document.getElementById('exam-rx').checked, rx_other: document.getElementById('exam-rx-other').value,
                    ultrasound: document.getElementById('exam-ultrasound').checked, ecofast: document.getElementById('exam-ecofast').checked,
                    emogas: document.getElementById('exam-emogas').checked,
                    surgery: document.getElementById('exam-surgery').checked, surgery_other: document.getElementById('exam-surgery-other').value.trim(),
                    lab: document.getElementById('exam-lab').checked, lab_other: document.getElementById('exam-lab-other').value.trim(),
                    other: document.getElementById('exam-other').checked, other_other: document.getElementById('exam-other-other').value.trim(),
                },
                customExams: customExams,
                examsExecuted: {
                    cbc: document.getElementById('executed-exam-cbc').checked,
                    biochem: document.getElementById('executed-exam-biochem').checked,
                    biochem_other: document.getElementById('executed-exam-biochem-other').value.trim(),
                    snap: document.getElementById('executed-exam-snap').checked,
                    urinalysis: document.getElementById('executed-exam-urinalysis').checked,
                    pucu: document.getElementById('executed-exam-pucu').checked,
                    rx: document.getElementById('executed-exam-rx').checked,
                    ultrasound: document.getElementById('executed-exam-ultrasound').checked,
                    ecofast: document.getElementById('executed-exam-ecofast').checked,
                    emogas: document.getElementById('executed-exam-emogas').checked,
                    surgery: document.getElementById('executed-exam-surgery').checked,
                    lab: document.getElementById('executed-exam-lab').checked,
                    other_text: document.getElementById('executed-exam-other-text').value.trim(),
                },
                infusionTherapy: getDynamicEntries('dynamic-infusion-inputs'),
                drugsToAdminister: Array.from(document.querySelectorAll('#dynamic-drug-inputs input')).map(input => input.value.trim()).filter(Boolean),
                medicalCourse: document.getElementById('medicalCourse').value.trim(),
                dischargeConditions: document.getElementById('dischargeConditions').value.trim(),
                homeTherapy: document.getElementById('homeTherapy').value.trim(),
                followUp: document.getElementById('followUp').value.trim(),
                importantMessage: importantMessageData,
                monitoringEntries: getDynamicEntries('monitoring-entries-container'),
                therapyLog: getDynamicEntries('therapy-log-container'),
                fluidTherapyEntries: getDynamicEntries('fluid-therapy-container'), // Nuovo campo per la fluidoterapia
                updatedAt: new Date(),
            };

            if (!patientData.ownerLastname || !patientData.patientName || !patientData.weight) {
                displayMessage("Compila tutti i campi anagrafici obbligatori (*).", "error");
                window.scrollTo({ top: 0, behavior: 'smooth' });
                return;
            }

            try {
                if (currentPatientId) {
                    await patientsCollection.doc(currentPatientId).update(patientData);
                    displayMessage("Scheda aggiornata con successo!", "success");
                } else {
                    await patientsCollection.add({
                        ...patientData,
                        createdAt: new Date()
                    });
                    displayMessage("Scheda salvata con successo!", "success");
                    clearForm();
                }
                renderPatientsList();
            } catch (error) {
                console.error("Errore nel salvataggio dei dati:", error);
                displayMessage("Errore nel salvataggio dei dati.", "error");
            }
        }
        saveButton.addEventListener('click', saveData);

        async function deletePatientData(id) {
            if (confirm("Sei sicuro di voler eliminare questa scheda paziente? Questa azione è irreversibile.")) {
                try {
                    await patientsCollection.doc(id).delete();
                    displayMessage("Scheda eliminata con successo.", "success");
                    clearForm();
                    renderPatientsList();
                } catch (error) {
                    console.error("Errore nell'eliminazione della scheda:", error);
                    displayMessage("Errore nell'eliminazione della scheda.", "error");
                }
            }
        }

        window.onload = () => {
            clearForm();
        };
    </script>
</body>
</html>
