<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scheda Degenza Paziente Interattiva</title>

    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyCy9YtgkIEoye2v4XJmXWv-wcHCY2XtgLU",
        authDomain: "cartella-clinica-veterinaria.firebaseapp.com",
        projectId: "cartella-clinica-veterinaria",
        storageBucket: "cartella-clinica-veterinaria.firebasestorage.app",
        messagingSenderId: "331086829436",
        appId: "1:331086829436:web:06a9a6bb54003c95f7b6f9"
      };
      firebase.initializeApp(firebaseConfig);
    </script>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 1200px;
        }
        .form-section {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            background-color: #ffffff;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        .no-print {
            display: block;
        }
        @media print {
            body {
                background-color: #fff;
            }
            .no-print, .patient-list, #patient-selection {
                display: none !important;
            }
            .printable-data, input, textarea, select {
                border: none !important;
                background-color: transparent !important;
            }
            .form-section {
                box-shadow: none;
                border: none;
                padding: 0;
                margin-bottom: 0.5rem;
            }
            .page-break {
                page-break-before: always;
            }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="container mx-auto">
        <h1 class="text-3xl md:text-4xl font-bold text-center mb-6 text-gray-800">Scheda Degenza Paziente</h1>

        <!-- Lista Pazienti (no-print) -->
        <div id="patient-selection" class="no-print mb-8 form-section">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Seleziona Paziente</h2>
            <div class="flex items-center space-x-4">
                <select id="patient-list" class="flex-grow px-4 py-2 bg-gray-100 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
                <button id="new-patient-btn" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">Nuovo Paziente</button>
            </div>
        </div>

        <!-- Form Scheda Degenza -->
        <form id="patient-form">
            <!-- Dati Anagrafici e Clinici -->
            <div class="form-section">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6 border-b pb-2">Dati Anagrafici e Clinici</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">Nome Paziente</label><input type="text" id="patient-name" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 printable-data"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">Specie</label><input type="text" id="species" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 printable-data"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">Razza</label><input type="text" id="breed" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 printable-data"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">Peso (kg)</label><input type="number" step="0.1" id="weight" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 printable-data"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">Nome Proprietario</label><input type="text" id="owner-name" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 printable-data"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">Data Ricovero</label><input type="date" id="admission-date" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 printable-data"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">Motivo Ricovero</label><input type="text" id="admission-reason" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 printable-data"></div>
                </div>
                <div class="mt-6">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Anamnesi e Diagnosi</label>
                    <textarea id="anamnesis-diagnosis" rows="4" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 printable-data"></textarea>
                </div>
            </div>

            <!-- Terapia e Note -->
            <div class="form-section">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6 border-b pb-2">Terapia e Note</h2>
                <div class="grid grid-cols-1 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Terapia Orale/Iniettiva (da Seguire)</label>
                        <textarea id="medication-notes" rows="4" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 printable-data"></textarea>
                    </div>
                    <!-- Nuova sezione Fluidoterapia -->
                    <div id="iv-fluid-section" class="form-section mt-6">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-6 border-b pb-2">Fluidoterapia</h2>
                        <div id="dynamic-infusion-inputs">
                            <!-- Le flebo verranno aggiunte qui -->
                        </div>
                        <button type="button" id="add-infusion-btn" class="no-print mt-4 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">Aggiungi Flebo</button>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Note Cliniche</label>
                        <textarea id="clinical-notes" rows="4" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 printable-data"></textarea>
                    </div>
                </div>
            </div>

            <!-- Valutazione Medica -->
            <div class="form-section page-break">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6 border-b pb-2">Valutazione Medica</h2>
                <div class="grid grid-cols-1 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Valutazione e Decorso Medico</label>
                        <textarea id="medical-evaluation" rows="4" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 printable-data"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Condizioni alle Dimissioni (con eventuale diagnosi)</label>
                        <textarea id="discharge-conditions" rows="4" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 printable-data"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Terapie da Continuare a Casa</label>
                        <textarea id="home-therapies" rows="4" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 printable-data"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Follow-up</label>
                        <textarea id="follow-up" rows="4" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 printable-data"></textarea>
                    </div>
                </div>
            </div>

            <!-- Flebo Template (hidden) -->
            <div id="infusion-row-template" class="infusion-row p-4 border rounded-lg bg-gray-50 relative hidden printable-data">
                <button type="button" class="remove-infusion-btn absolute top-2 right-2 text-red-500 hover:text-red-700 no-print">&times;</button>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">Tipo di Flebo</label><input type="text" data-field="ivFluids" class="w-full px-4 py-2 bg-white border rounded-lg printable-data"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">Volume</label><input type="text" data-field="ivVolume" class="w-full px-4 py-2 bg-white border rounded-lg printable-data"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">Via di Somministrazione</label><input type="text" data-field="ivRoute" class="w-full px-4 py-2 bg-white border rounded-lg printable-data"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">Velocità</label><select data-field="ivRate" class="w-full px-4 py-2 bg-white border rounded-lg printable-data"><option>Bolo veloce</option><option>Bolo lento</option><option>Goccia veloce</option><option>Goccia lenta</option><option>Pompa ad infusione</option></select></div>
                </div>
                <div class="mt-4"><label class="block text-sm font-medium text-gray-700 mb-1">Pompa infusione ml/kg/h</label><input type="text" data-field="ivRateOther" class="w-full px-4 py-2 bg-white border rounded-lg printable-data"></div>
            </div>

            <!-- Pulsanti di Azione (no-print) -->
            <div class="no-print flex space-x-4 justify-center mt-8">
                <button type="button" id="save-button" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-colors">Salva</button>
                <button type="button" id="delete-button" class="px-6 py-3 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition-colors hidden">Elimina</button>
                <button type="button" id="print-button" class="px-6 py-3 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700 transition-colors">Stampa</button>
            </div>
        </form>

        <!-- Message box for user feedback -->
        <div id="message-box" class="fixed bottom-4 right-4 p-4 rounded-lg text-white shadow-lg transition-opacity duration-300 opacity-0 hidden"></div>

    </div>

<script>
    const db = firebase.firestore();
    const patientsCollection = db.collection('patients');

    const form = document.getElementById('patient-form');
    const patientListSelect = document.getElementById('patient-list');
    const saveButton = document.getElementById('save-button');
    const deleteButton = document.getElementById('delete-button');
    const newPatientBtn = document.getElementById('new-patient-btn');
    const printButton = document.getElementById('print-button');
    const addInfusionBtn = document.getElementById('add-infusion-btn');
    const dynamicInfusionInputs = document.getElementById('dynamic-infusion-inputs');
    const infusionTemplate = document.getElementById('infusion-row-template');
    const messageBox = document.getElementById('message-box');

    let currentPatientId = null;

    function displayMessage(message, type) {
        messageBox.textContent = message;
        messageBox.className = `fixed bottom-4 right-4 p-4 rounded-lg text-white shadow-lg transition-opacity duration-300 opacity-100`;
        if (type === 'success') {
            messageBox.classList.add('bg-green-500');
        } else if (type === 'error') {
            messageBox.classList.add('bg-red-500');
        } else {
            messageBox.classList.add('bg-gray-500');
        }

        setTimeout(() => {
            messageBox.classList.remove('opacity-100');
            messageBox.classList.add('opacity-0');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 300);
        }, 3000);
    }

    function clearForm() {
        form.reset();
        currentPatientId = null;
        deleteButton.classList.add('hidden');
        patientListSelect.value = "";
        dynamicInfusionInputs.innerHTML = "";
    }

    async function loadPatientData(id) {
        try {
            const doc = await patientsCollection.doc(id).get();
            if (doc.exists) {
                const data = doc.data();
                document.getElementById('patient-name').value = data.patientName || '';
                document.getElementById('species').value = data.species || '';
                document.getElementById('breed').value = data.breed || '';
                document.getElementById('weight').value = data.weight || '';
                document.getElementById('owner-name').value = data.ownerName || '';
                document.getElementById('admission-date').value = data.admissionDate || '';
                document.getElementById('admission-reason').value = data.admissionReason || '';
                document.getElementById('anamnesis-diagnosis').value = data.anamnesisDiagnosis || '';
                document.getElementById('medication-notes').value = data.medicationNotes || '';
                document.getElementById('clinical-notes').value = data.clinicalNotes || '';
                document.getElementById('medical-evaluation').value = data.medicalEvaluation || '';
                document.getElementById('discharge-conditions').value = data.dischargeConditions || '';
                document.getElementById('home-therapies').value = data.homeTherapies || '';
                document.getElementById('follow-up').value = data.followUp || '';

                // Load infusions
                dynamicInfusionInputs.innerHTML = "";
                if (data.ivTherapy && Array.isArray(data.ivTherapy)) {
                    data.ivTherapy.forEach(infusion => {
                        const newInfusionRow = infusionTemplate.cloneNode(true);
                        newInfusionRow.id = '';
                        newInfusionRow.classList.remove('hidden');
                        
                        // Populate fields
                        newInfusionRow.querySelector('input[data-field="ivFluids"]').value = infusion.ivFluids || '';
                        newInfusionRow.querySelector('input[data-field="ivVolume"]').value = infusion.ivVolume || '';
                        newInfusionRow.querySelector('input[data-field="ivRoute"]').value = infusion.ivRoute || '';
                        newInfusionRow.querySelector('select[data-field="ivRate"]').value = infusion.ivRate || 'Bolo veloce';
                        newInfusionRow.querySelector('input[data-field="ivRateOther"]').value = infusion.ivRateOther || '';
                        
                        dynamicInfusionInputs.appendChild(newInfusionRow);

                        // Add event listener to the new remove button
                        newInfusionRow.querySelector('.remove-infusion-btn').addEventListener('click', () => {
                            newInfusionRow.remove();
                        });
                    });
                }
                
                currentPatientId = id;
                deleteButton.classList.remove('hidden');
            } else {
                displayMessage("Scheda paziente non trovata.", "error");
            }
        } catch (error) {
            console.error("Errore nel caricamento dei dati:", error);
            displayMessage("Errore nel caricamento dei dati.", "error");
        }
    }

    function addInfusionRow() {
        const newInfusionRow = infusionTemplate.cloneNode(true);
        newInfusionRow.id = '';
        newInfusionRow.classList.remove('hidden');
        dynamicInfusionInputs.appendChild(newInfusionRow);

        // Add event listener to the new remove button
        newInfusionRow.querySelector('.remove-infusion-btn').addEventListener('click', () => {
            newInfusionRow.remove();
        });
    }

    async function renderPatientsList() {
        patientListSelect.innerHTML = '<option value="">-- Seleziona Paziente --</option>';
        try {
            const snapshot = await patientsCollection.orderBy('createdAt', 'desc').get();
            snapshot.docs.forEach(doc => {
                const data = doc.data();
                if (data.patientName) {
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = data.patientName;
                    patientListSelect.appendChild(option);
                }
            });
        } catch (error) {
            console.error("Errore nel caricamento della lista pazienti:", error);
            displayMessage("Errore nel caricamento della lista pazienti.", "error");
        }
    }
    
    async function saveData() {
        const patientName = document.getElementById('patient-name').value;
        if (!patientName) {
            displayMessage("Inserire il nome del paziente.", "error");
            return;
        }

        // Get infusion data
        const infusionRows = document.querySelectorAll('#dynamic-infusion-inputs .infusion-row:not(#infusion-row-template)');
        const ivTherapy = [];
        infusionRows.forEach(row => {
            const infusionData = {
                ivFluids: row.querySelector('[data-field="ivFluids"]').value,
                ivVolume: row.querySelector('[data-field="ivVolume"]').value,
                ivRoute: row.querySelector('[data-field="ivRoute"]').value,
                ivRate: row.querySelector('[data-field="ivRate"]').value,
                ivRateOther: row.querySelector('[data-field="ivRateOther"]').value
            };
            ivTherapy.push(infusionData);
        });

        const patientData = {
            patientName: document.getElementById('patient-name').value,
            species: document.getElementById('species').value,
            breed: document.getElementById('breed').value,
            weight: document.getElementById('weight').value,
            ownerName: document.getElementById('owner-name').value,
            admissionDate: document.getElementById('admission-date').value,
            admissionReason: document.getElementById('admission-reason').value,
            anamnesisDiagnosis: document.getElementById('anamnesis-diagnosis').value,
            medicationNotes: document.getElementById('medication-notes').value,
            ivTherapy: ivTherapy, // Aggiunta la fluidoterapia
            clinicalNotes: document.getElementById('clinical-notes').value,
            medicalEvaluation: document.getElementById('medical-evaluation').value,
            dischargeConditions: document.getElementById('discharge-conditions').value,
            homeTherapies: document.getElementById('home-therapies').value,
            followUp: document.getElementById('follow-up').value,
            updatedAt: new Date()
        };

        try {
            if (currentPatientId) {
                await patientsCollection.doc(currentPatientId).update(patientData);
                displayMessage("Scheda aggiornata con successo!", "success");
            } else {
                await patientsCollection.add({
                    ...patientData,
                    createdAt: new Date()
                });
                displayMessage("Scheda salvata con successo!", "success");
                clearForm();
            }
            renderPatientsList();
        } catch (error) {
            console.error("Errore nel salvataggio dei dati:", error);
            displayMessage("Errore nel salvataggio dei dati.", "error");
        }
    }
    saveButton.addEventListener('click', saveData);

    async function deletePatientData(id) {
        if (confirm("Sei sicuro di voler eliminare questa scheda paziente? Questa azione è irreversibile.")) {
            try {
                await patientsCollection.doc(id).delete();
                displayMessage("Scheda eliminata con successo.", "success");
                clearForm();
                renderPatientsList();
            } catch (error) {
                console.error("Errore nell'eliminazione della scheda:", error);
                displayMessage("Errore nell'eliminazione della scheda.", "error");
            }
        }
    }

    // Event Listeners
    patientListSelect.addEventListener('change', (e) => {
        const id = e.target.value;
        if (id) {
            loadPatientData(id);
        } else {
            clearForm();
        }
    });

    newPatientBtn.addEventListener('click', clearForm);

    deleteButton.addEventListener('click', () => {
        if (currentPatientId) {
            deletePatientData(currentPatientId);
        }
    });

    addInfusionBtn.addEventListener('click', addInfusionRow);
    
    printButton.addEventListener('click', () => {
        window.print();
    });

    window.onload = () => {
        renderPatientsList();
        clearForm();
    };
</script>
</body>
</html>
